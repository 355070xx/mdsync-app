# 冷靜通道聊天室功能總結

## 🎯 功能概述

「冷靜通道聊天室」是 MoodSync App 的一個特殊功能，為配對情侶提供一個獨立的情緒對話空間，用於處理情緒激烈時的溝通需求。

## ✨ 核心特點

### 🔒 安全性設計
- **配對限制**：只有已配對的情侶才能使用
- **臨時性**：所有訊息 7 天後自動過期
- **隱私保護**：不會出現在一般聊天紀錄中
- **無通知干擾**：不觸發 FCM 推送通知

### 💬 訊息類型
- **一般訊息** (💬)：普通文字交流
- **道歉** (🙏)：表達歉意
- **擁抱** (🫂)：給予安慰和支持
- **拒絕** (❌)：明確表達不接受
- **中性** (😐)：表達中性態度

### 🎨 UI/UX 設計
- **冷靜色調**：灰色漸層背景，營造平靜氛圍
- **警告提示**：進入時顯示功能說明
- **圓角設計**：符合 MoodSync 的整體設計風格
- **快速回應**：對道歉訊息提供「和好吧」/「等一下」快速回覆

## 📂 檔案結構

### 1. 資料模型
- **`EmotionChatMessage.swift`**: 訊息資料結構
  - 包含訊息類型、過期時間、發送者資訊
  - 提供時間格式化和過期檢查功能

- **`EmotionChatMetadata`**: 聊天室狀態管理
  - 控制聊天室的啟用/停用狀態

### 2. 業務邏輯
- **`EmotionChatViewModel.swift`**: 核心邏輯處理
  - 訊息發送與接收
  - 即時監聽 Firestore 變化
  - 配對狀態驗證
  - 過期訊息過濾

### 3. 使用者介面
- **`EmotionChatView.swift`**: 主要聊天介面
  - 三種狀態：未配對 / 聊天未啟用 / 聊天進行中
  - 訊息類型選擇器
  - 快速回應按鈕
  - 輸入框和發送功能

- **`MessageBubbleView`**: 訊息氣泡元件
  - 區分自己/對方訊息的視覺呈現
  - 道歉訊息的快速回應按鈕

## 🗄️ Firestore 資料結構

```
emotionChats/{pairID}/
├── metadata/
│   └── status/
│       ├── isEmotionChatEnabled: Boolean
│       └── lastOpened: Timestamp
└── messages/{messageID}/
    ├── fromUID: String
    ├── fromName: String
    ├── emoji: String?
    ├── text: String?
    ├── type: "message" | "apology" | "hug" | "reject" | "neutral"
    ├── createdAt: Timestamp
    └── expiresAt: Timestamp
```

### PairID 生成規則
- 格式：`uid1_uid2`
- 兩個 UID 按字典序排序，確保唯一性

## 🔐 安全規則

### Firestore Rules 保護
- **配對驗證**：只有配對的用戶可以訪問對應的聊天室
- **訊息完整性**：強制檢查必要欄位和訊息類型
- **不可修改**：訊息一旦發送無法編輯或刪除
- **過期驗證**：確保訊息設定了未來的過期時間

## 🚀 使用流程

### 1. 啟用冷靜通道
1. 用戶在主界面點擊「🌧️ 想開啟冷靜通道？」
2. 系統檢查是否已配對
3. 顯示功能說明和警告
4. 用戶確認後啟用聊天室

### 2. 發送訊息
1. 選擇訊息類型（預設為「一般訊息」）
2. 輸入文字內容或使用快速回應
3. 系統自動設定 7 天過期時間
4. 即時同步到對方裝置

### 3. 接收與回應
1. 即時接收對方訊息
2. 針對道歉訊息顯示快速回應按鈕
3. 可選擇「🫂 和好吧」或「🤔 等一下」
4. 支援一般回覆和快速回應混合使用

### 4. 結束對話
1. 任一方可點擊「關閉通道」
2. 聊天室狀態設為停用
3. 歷史訊息保留但無法發送新訊息
4. 7 天後所有訊息自動清除

## 🎭 使用場景

### 適用情況
- 情侶間發生爭執需要冷靜溝通
- 需要表達歉意但不想留下永久記錄
- 希望在私密空間處理情緒問題
- 避免在主要聊天工具中累積負面記錄

### 設計理念
- **臨時性**：避免翻舊帳，專注當下問題解決
- **安全感**：獨立空間讓雙方更放心表達
- **引導性**：訊息類型引導正向溝通方式
- **簡潔性**：介面簡潔，減少干擾因素

## 🛡️ 隱私保護

### 資料自動清理
- 訊息 7 天後自動過期
- 前端主動過濾已過期訊息
- 未來可通過 Cloud Functions 定期清理

### 靜默模式
- 不發送推送通知
- 不在主界面顯示未讀提示
- 保持溝通的私密性

## 🔮 未來擴展

### 可能的功能增強
- **情緒分析**：分析對話情緒走向
- **建議回覆**：AI 建議合適的回應
- **時間限制**：設定聊天室自動關閉時間
- **模板訊息**：提供常用的和解模板
- **導出功能**：在過期前導出重要對話（可選）

---

## 📋 技術實現摘要

- **框架**：SwiftUI + Firebase
- **即時同步**：Firestore Listeners
- **狀態管理**：ObservableObject + @Published
- **安全性**：Firestore Security Rules
- **UI 設計**：符合 iOS 設計規範的現代化介面

這個功能為 MoodSync App 提供了一個獨特的情侶溝通工具，在保護隱私的同時促進健康的情感交流。 