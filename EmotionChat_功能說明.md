# 🌧️ 冷靜對話空間（Emotion Chat）功能說明

## 📋 功能概覽

您的《MoodSync》App 已成功實現「冷靜對話空間」功能，以下是完整的功能說明和使用指南。

## ✨ 核心特色

### 🔒 隱私保護
- **僅限配對用戶**：只有已配對的情侶才能使用此功能
- **手動啟用**：需要任一方主動開啟冷靜通道
- **7天自動清除**：所有訊息會在7天後自動過期並清除
- **獨立空間**：與主要聊天記錄分離，提供安全的情緒表達環境

### 💬 訊息類型
支援5種不同的情緒訊息類型：
- 🙏 **道歉**（apology）：表達歉意和反省
- 🫂 **擁抱**（hug）：給予安慰和支持
- ❌ **拒絕**（reject）：暫時需要空間
- 💬 **一般訊息**（message）：普通的溝通
- 😐 **中性**（neutral）：不帶情緒的表達

### 🎨 UI 設計
- **冷靜色調**：使用灰系和淺色漸層，營造寧靜氛圍
- **清晰區隔**：與主 App 的粉色系形成對比
- **簡約介面**：專注於溝通本身，減少干擾
- **直覺操作**：簡單的發送和回應機制

## 🚀 使用流程

### 1. 進入冷靜通道
1. 在主頁面找到「🌧️ 想開啟冷靜通道？」按鈕
2. 點擊進入冷靜空間介面
3. 系統會顯示警告提示：「對話不會儲存於歷史紀錄，7天後自動消失」

### 2. 開啟對話
- 如果通道未啟用，點擊「開始對話」按鈕
- 系統會同步啟用雙方的冷靜通道
- 開啟後即可開始發送訊息

### 3. 發送訊息
- **文字輸入**：在底部輸入框輸入想說的話
- **選擇類型**：點擊類型選擇器，選擇合適的訊息類型
- **快速回應**：使用預設的 emoji 快速表達情緒
- **組合發送**：可以同時包含文字、emoji 和訊息類型

### 4. 特殊回應功能
對於道歉、擁抱、拒絕類型的訊息，接收方可以：
- ✅ **接受**：表示理解和接納
- 🕓 **稍後再回應**：暫時無法回應但已收到

## 🧪 測試功能

為了方便測試和展示，我們新增了以下測試功能：

### 測試資料生成
點擊右上角「⋯」選單 → 「🧪 添加測試資料」
系統會自動生成8則模擬對話，包含：
- 道歉和和解的對話
- 擁抱和安慰的互動
- 冷靜思考的溝通
- 解決問題的討論

### 過期訊息清理
點擊右上角「⋯」選單 → 「🗑️ 清理過期訊息」
手動清除所有已過期的訊息

## 🔧 技術實現

### 數據結構
```
emotionChats/{pairID}/
├── metadata/
│   └── status/
│       └── isEmotionChatEnabled: Boolean
└── messages/{messageID}
    ├── fromUID: String
    ├── fromName: String
    ├── emoji: String?
    ├── text: String?
    ├── type: MessageType
    ├── createdAt: Timestamp
    ├── expiresAt: Timestamp
    ├── replyStatus: ReplyStatus?
    └── replyByUID: String?
```

### 自動清理機制
- **前端過濾**：即時過濾已過期的訊息
- **後端清理**：定期刪除過期的訊息文件
- **批次處理**：使用 Firestore batch 提升效能

### 即時同步
- 使用 Firestore Listeners 實現即時同步
- 雙方狀態變更會立即反映
- 訊息發送後即時顯示在雙方介面

## 🛡️ 安全與隱私

### Firestore 安全規則
- 只有配對的用戶才能訪問對應的聊天室
- 防止未授權的讀取和寫入
- 驗證訊息格式和必要欄位

### 資料保護
- 所有訊息都有明確的過期時間
- 自動清理機制確保資料不會無限累積
- 聊天室可以隨時關閉

## 📱 操作指南

### 開發者測試
1. 確保有兩個已配對的測試帳號
2. 在其中一個帳號開啟冷靜通道
3. 使用「添加測試資料」快速生成對話
4. 在另一個帳號查看同步效果
5. 測試各種訊息類型和回應功能

### 使用者體驗
1. 在情緒激動時提供冷靜的溝通空間
2. 透過訊息類型明確表達意圖
3. 7天過期機制減少心理負擔
4. 簡約設計專注於溝通本質

## 🎯 後續發展

### 可能的改進方向
- 新增語音訊息支援
- 加入情緒分析功能
- 提供對話匯出功能
- 增加更多快速回應選項
- 支援群組冷靜對話

### 效能優化
- 實現更智慧的本地快取
- 優化大量訊息的載入
- 減少 Firestore 讀取次數

---

**注意**：此功能目前在 `feature/emotion-chat` 分支中獨立開發，確保不會影響主線功能的穩定性。所有測試都應該在此分支中進行。 